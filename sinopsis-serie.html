<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="series-title-page">Cargando...</title>
    <link rel="stylesheet" href="https://cdn.plyr.io/3.7.8/plyr.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        :root { --dark-bg: #1a1a2e; --dark-card: #2c2c44; --red-heart: #e74c3c; --text-light: #ecf0f1; --plyr-color-main: var(--red-heart); }
        body { font-family: 'Arial', sans-serif; background-color: var(--dark-bg); color: var(--text-light); margin: 0; padding: 0; }
        .series-header { position: relative; height: 50vh; }
        .backdrop-img { width: 100%; height: 100%; object-fit: cover; filter: brightness(0.5); }
        .series-info { position: absolute; bottom: 0; left: 0; right: 0; padding: 20px; background: linear-gradient(to top, var(--dark-bg), transparent); display: flex; gap: 20px; align-items: flex-end; }
        .poster-img { width: 120px; border-radius: 5px; box-shadow: 0 5px 15px black; }
        .series-details h1 { margin: 0 0 10px; }
        .series-details p { margin: 0; font-size: 0.9em; line-height: 1.5; max-height: 70px; overflow: hidden; }
        .episodes-section { padding: 20px; }
        .season-selector { width: 100%; padding: 10px; background-color: var(--dark-card); color: var(--text-light); border: 1px solid #555; border-radius: 5px; font-size: 1.1em; margin-bottom: 20px; }
        .episode-list { list-style: none; padding: 0; margin: 0; }
        .episode-item { display: flex; align-items: center; gap: 15px; padding: 15px; background-color: var(--dark-card); border-radius: 5px; margin-bottom: 10px; cursor: pointer; transition: background-color 0.2s; }
        .episode-item:hover { background-color: #3c3c54; }
        .episode-number { font-size: 1.2em; font-weight: bold; color: #95a5a6; }
        .episode-title { font-size: 1em; }
        #video-player-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: black; z-index: 2000; }
        .player-container { width: 100%; height: 100%; }
    </style>
</head>
<body>
    <div id="series-content">
        <header class="series-header">
            <img id="series-backdrop" src="" class="backdrop-img">
            <div class="series-info">
                <img id="series-poster" src="" class="poster-img">
                <div class="series-details">
                    <h1 id="series-title"></h1>
                    <p id="series-overview"></p>
                </div>
            </div>
        </header>
        <main class="episodes-section">
            <select id="season-selector" class="season-selector"></select>
            <ul id="episodes-list" class="episode-list"></ul>
        </main>
    </div>
    
    <div id="video-player-modal">
        <div class="player-container">
            <video id="video-player" playsinline controls></video>
        </div>
    </div>

    <script src="https://cdn.plyr.io/3.7.8/plyr.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, doc, getDoc, collection, getDocs, orderBy, query } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        const firebaseConfig = {
          apiKey: "AIzaSyCLGiT_UeTm578cQeCwLldH50qOjounCOs",
          authDomain: "miappdetv-db.firebaseapp.com",
          databaseURL: "https://miappdetv-db-default-rtdb.firebaseio.com",
          projectId: "miappdetv-db",
          storageBucket: "miappdetv-db.firebasestorage.app",
          messagingSenderId: "515640857376",
          appId: "1:515640857376:web:89e5bb051ee79f030c3d45"
        };

        // --- LÍNEAS CORREGIDAS Y AÑADIDAS ---
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app); // Ahora 'db' está definido
        const auth = getAuth(app);
        // ------------------------------------

        const seriesId = new URLSearchParams(window.location.search).get('id');
        const seasonSelector = document.getElementById('season-selector');
        const episodesList = document.getElementById('episodes-list');
        const videoPlayerModal = document.getElementById('video-player-modal');
        let player;
        
        async function loadSeriesDetails() {
            if (!seriesId) { document.body.innerHTML = "<h1>ID de serie no encontrado</h1>"; return; }
            const seriesRef = doc(db, "series", seriesId);
            const seriesSnap = await getDoc(seriesRef);
            if (!seriesSnap.exists()) { document.body.innerHTML = "<h1>Serie no encontrada</h1>"; return; }
            
            const seriesData = seriesSnap.data();
            document.getElementById('series-title-page').textContent = seriesData.titulo;
            document.getElementById('series-backdrop').src = seriesData.backdrop_url || seriesData.poster_url;
            document.getElementById('series-poster').src = seriesData.poster_url;
            document.getElementById('series-title').textContent = seriesData.titulo;
            document.getElementById('series-overview').textContent = seriesData.sinopsis; // Asumiendo que guardas sinopsis

            const temporadasRef = collection(db, `series/${seriesId}/temporadas`);
            
            // TMDb a veces crea una "Temporada 0" para especiales, la filtramos
            const temporadasSnap = await getDocs(temporadasRef);
            const temporadas = temporadasSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));

            // Ordenamos por número de temporada (extrayendo el número del id "temporada_X")
            temporadas.sort((a, b) => {
                const numA = parseInt(a.id.split('_')[1] || 0);
                const numB = parseInt(b.id.split('_')[1] || 0);
                return numA - numB;
            });
            
            seasonSelector.innerHTML = ''; // Limpiamos antes de añadir
            temporadas.forEach(temporada => {
                const option = document.createElement('option');
                option.value = temporada.id; // e.g., "temporada_1"
                // El nombre de la temporada no lo guardabas, así que lo generamos
                option.textContent = `Temporada ${temporada.id.split('_')[1]}`; 
                seasonSelector.appendChild(option);
            });

            if (temporadas.length > 0) {
                loadEpisodes(temporadas[0].id);
            } else {
                episodesList.innerHTML = '<li>No hay temporadas para esta serie.</li>';
            }
        }
        
        async function loadEpisodes(temporadaId) {
            episodesList.innerHTML = '<li>Cargando episodios...</li>';
            const episodiosRef = collection(db, `series/${seriesId}/temporadas/${temporadaId}/episodios`);
            const q = query(episodiosRef, orderBy("numero"));
            const episodiosSnap = await getDocs(q);
            episodesList.innerHTML = '';
            
            if (episodiosSnap.empty) {
                episodesList.innerHTML = '<li>No se encontraron episodios para esta temporada.</li>';
                return;
            }

            episodiosSnap.forEach(epDoc => {
                const epData = epDoc.data();
                const li = document.createElement('li');
                li.className = 'episode-item';
                li.innerHTML = `
                    <span class="episode-number">${epData.numero}</span>
                    <div style="flex-grow: 1;">
                        <span class="episode-title">${epData.titulo}</span>
                    </div>
                    <i class="fas fa-play"></i>
                `;
                if(epData.video_url && epData.video_url.trim() !== '') {
                    li.onclick = () => playEpisode(epData.video_url, `Ep. ${epData.numero} - ${epData.titulo}`);
                } else {
                    li.style.cursor = 'not-allowed';
                    li.style.opacity = '0.5';
                    li.querySelector('.fa-play').style.display = 'none';
                }
                episodesList.appendChild(li);
            });
        }

        function playEpisode(videoUrl, title) {
            videoPlayerModal.style.display = 'flex';
            if (player) player.destroy();
            player = new Plyr('#video-player', { title: title });
            player.source = {
                type: 'video',
                title: title,
                sources: [{ src: videoUrl }],
            };
            player.play();
            try {
                if (player.fullscreen.enabled) {
                    player.fullscreen.enter();
                }
                screen.orientation?.lock('landscape').catch(()=>{});
            } catch(e) {}
            
            player.on('exitfullscreen', () => {
                player.pause();
                videoPlayerModal.style.display = 'none';
                screen.orientation?.unlock();
            });
        }

        seasonSelector.addEventListener('change', () => loadEpisodes(seasonSelector.value));

        // --- ESTRUCTURA DE CARGA MEJORADA ---
        async function main() {
            try {
                await signInAnonymously(auth);
                await loadSeriesDetails();
            } catch(e) {
                console.error("Error al cargar la página:", e);
                document.body.innerHTML = "<h1>Error al cargar los detalles de la serie.</h1>"
            }
        }

        main();
        // ------------------------------------
    </script>
</body>
</html>
