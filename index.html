<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MonkeyTV PRO</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <script type="text/javascript" src="https://www.gstatic.com/cv/js/sender/v1/cast_sender.js?loadCastFramework=1"></script>

    <style>
        :root {
            --dark-bg: #1a1a2e;
            --dark-card: #2c2c44;
            --red-heart: #e74c3c;
            --text-light: #ecf0f1;
            --text-muted: #95a5a6;
        }
        html { box-sizing: border-box; }
        *, *:before, *:after { box-sizing: inherit; }
        body {
            font-family: 'Arial', sans-serif;
            background-color: var(--dark-bg);
            color: var(--text-light);
            margin: 0;
            padding: 0;
            -webkit-font-smoothing: antialiased;
        }
        
        #messageBox {
            position: fixed; top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(0, 0, 0, 0.8);
            color: white; padding: 20px; border-radius: 10px;
            z-index: 2000; display: none; text-align: center;
        }

        .header { background-color: var(--dark-card); z-index: 100; }
        .header-top { display: flex; justify-content: space-between; align-items: center; padding: 10px; }
        .app-title { font-size: 1.2em; font-weight: bold; }
        .search-container { display: flex; align-items: center; position: relative; }
        google-cast-launcher {
            width: 24px;
            height: 24px;
            cursor: pointer;
            margin-left: 15px;
            --cast-button-color: var(--text-light);
        }
        .cast-icon { color: var(--text-muted); cursor: pointer; }
        #search-input { width: 0; opacity: 0; padding: 8px 15px; border-radius: 20px; border: 1px solid #555; background-color: #1a1a2e; color: #ecf0f1; transition: width 0.3s ease-in-out, opacity 0.3s ease-in-out; position: absolute; right: 0; z-index: -1; }
        #search-input.active { width: 200px; opacity: 1; z-index: 1; }
        .search-icon { font-size: 1.2em; cursor: pointer; z-index: 2; }

        .video-container { position: relative; width: 100%; padding-top: 56.25%; height: 0; overflow: hidden; background-color: #000; }
        .video-placeholder { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; flex-direction: column; justify-content: center; align-items: center; background-color: #000; color: var(--text-muted); text-align: center; padding: 10px; }
        .video-placeholder i { font-size: 4em; margin-bottom: 20px; }
        .video-player { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: contain; display: none; }
        .video-overlay { position: absolute; top: 0; left: 0; right: 0; bottom: 0; display: flex; flex-direction: column; justify-content: space-between; visibility: hidden; opacity: 1; transition: opacity 0.3s ease-in-out; z-index: 10; }
        .video-overlay.hidden { visibility: hidden; opacity: 0; }
        .video-overlay.visible { visibility: visible; opacity: 1; }
        .epg-info { background-color: rgba(44, 44, 68, 0.7); padding: 10px; color: #fff; }
        .epg-info h3 { margin: 0; font-size: 1.2em; font-weight: bold; }
        .video-custom-controls { background: linear-gradient(to top, rgba(0,0,0,0.8), rgba(0,0,0,0)); padding: 10px; }
        .video-controls-top { display: flex; align-items: center; justify-content: space-between; margin-bottom: 15px; }
        .video-controls-left { display: flex; align-items: center; gap: 15px; }
        .video-controls-right { display: flex; align-items: center; gap: 15px; }
        .video-custom-controls i { font-size: 1.5em; cursor: pointer; transition: color 0.2s; }
        .video-custom-controls i:hover { color: var(--red-heart); }
        .progress-bar-container, .volume-slider-container { width: 100%; height: 5px; background-color: rgba(255, 255, 255, 0.3); cursor: pointer; position: relative; }
        .progress-bar, .volume-slider { height: 100%; background-color: var(--red-heart); width: 0; }
        .time-info { font-size: 0.8em; color: var(--text-muted); margin-top: 5px; }
        .volume-controls { display: flex; align-items: center; gap: 10px; }
        .volume-slider-container { width: 80px; }

        .main-content-wrapper { padding-bottom: 70px; }
        .main-content { padding: 10px; }

        .categories-section {
            display: flex; overflow-x: auto; gap: 10px; padding: 10px 0;
            -webkit-overflow-scrolling: touch; scrollbar-width: none;
        }
        .categories-section::-webkit-scrollbar { display: none; }
        .category-item { background-color: var(--dark-card); padding: 8px 15px; border-radius: 20px; font-size: 0.8em; white-space: nowrap; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; }
        .category-item.active { background-color: var(--red-heart); }
        .category-item:focus, .channel-item:focus { outline: none; box-shadow: 0 0 0 2px var(--dark-bg), 0 0 0 4px var(--red-heart); transform: scale(1.02); }

        .channel-header { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; }
        .section-title { font-size: 1em; font-weight: bold; color: var(--text-light); }
        .channel-list { list-style: none; padding: 0; margin: 0; }
        .channel-item { display: flex; align-items: center; justify-content: space-between; background-color: var(--dark-card); border-radius: 10px; padding: 10px; margin-bottom: 10px; cursor: pointer; transition: all 0.3s ease; }
        .channel-item:hover { transform: translateY(-2px); }
        .channel-logo-container { display: flex; align-items: center; flex-grow: 1; }
        .channel-item .channel-logo { width: 50px; height: 50px; object-fit: contain; border-radius: 5px; margin-right: 10px; }
        .channel-details h3 { margin: 0; font-size: 1em; }
        .channel-details p { margin: 0; font-size: 0.8em; color: var(--text-muted); }
        .channel-actions { display: flex; align-items: center; gap: 15px; }
        .channel-actions .fa-heart { color: var(--text-muted); }
        .channel-actions .fa-heart.favorited { color: var(--red-heart); transform: scale(1.2); }

        .bottom-nav {
            display: flex; justify-content: space-around; align-items: center; height: 60px;
            background-color: var(--dark-card); border-top: 1px solid rgba(255, 255, 255, 0.1);
            position: fixed; bottom: 0; left: 0; right: 0; z-index: 1000;
        }
        .bottom-nav .nav-item { display: flex; flex-direction: column; align-items: center; text-decoration: none; color: var(--text-muted); font-size: 0.7em; text-align: center; }
        .bottom-nav .nav-item.active { color: var(--red-heart); }
        .bottom-nav .nav-item i { font-size: 1.4em; margin-bottom: 5px; }
        
        .spinner-container { display: flex; justify-content: center; align-items: center; padding: 40px; }
        .spinner { border: 4px solid rgba(255, 255, 255, 0.3); border-radius: 50%; border-top: 4px solid var(--red-heart); width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .side-nav { display: none; }

        @media (min-width: 992px) {
            body { 
                height: 100vh;
            }
            .desktop-layout-container { display: flex; width: 100%; height: 100%; }
            .header { position: relative; width: 60%; height: 100%; display: flex; flex-direction: column; }
            .header-top { flex-shrink: 0; }
            .video-container { flex-grow: 1; padding-top: 0; height: auto; }
            .right-panel {
                display: flex;
                width: 40%;
                height: 100%;
                background-color: var(--dark-bg);
            }
            .side-nav {
                display: flex;
                flex-direction: column;
                width: 100px;
                background-color: var(--dark-card);
                padding-top: 20px;
                flex-shrink: 0;
            }
            .side-nav .nav-item { display: flex; flex-direction: column; align-items: center; text-decoration: none; color: var(--text-muted); padding: 15px 0; width: 100%; transition: background-color 0.2s, color 0.2s; }
            .side-nav .nav-item:hover { background-color: rgba(255, 255, 255, 0.1); }
            .side-nav .nav-item.active { color: var(--red-heart); border-left: 3px solid var(--red-heart); }
            .side-nav .nav-item i { font-size: 1.8em; margin-bottom: 8px; }
            .side-nav .nav-item span { font-size: 0.8em; }
            .side-nav .nav-item:focus { outline: none; box-shadow: inset 0 0 0 2px var(--red-heart); }
            .main-content-wrapper { width: 100%; height: 100%; overflow-y: auto; padding-bottom: 0; }
            .bottom-nav { display: none; }
        }
    </style>
</head>
<body>
    <div id="messageBox"></div>
    <div class="desktop-layout-container">

        <header class="header">
            <div class="header-top">
                <span class="app-title">MonkeyTV PRO</span>
                <div class="search-container">
                    <input type="text" id="search-input" placeholder="Buscar canal...">
                    <i class="fas fa-search search-icon"></i>
                    <google-cast-launcher id="castButton"></google-cast-launcher>
                </div>
            </div>
            <div class="video-container" id="video-container">
                <div class="video-placeholder">
                    <i class="fas fa-tv"></i>
                    <span>Selecciona un canal de la lista para reproducir</span>
                </div>
                <video id="videoPlayer" class="video-player" autoplay preload="auto"></video>
                <div class="video-overlay hidden">
                     <div class="epg-info"><h3 id="epgCurrentProgram"></h3></div>
                    <div class="video-custom-controls">
                        <div class="progress-bar-container" id="progressBarContainer"><div class="progress-bar" id="progressBar"></div></div>
                        <div class="video-controls-top">
                            <div class="video-controls-left">
                                <i id="playPauseBtn" class="fas fa-pause"></i>
                                <div class="volume-controls">
                                    <i id="muteBtn" class="fas fa-volume-up"></i>
                                    <div class="volume-slider-container" id="volumeSliderContainer"><div class="volume-slider" id="volumeSlider"></div></div>
                                </div>
                            </div>
                            <div class="video-controls-right">
                                <span id="videoTime" class="time-info">00:00 / 00:00</span>
                                <i id="fullscreenBtn" class="fas fa-expand"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </header>
        
        <div class="right-panel">
            <nav class="side-nav">
                <a href="index.html" class="nav-item active" data-view="all" tabindex="0"><i class="fas fa-home"></i> <span>Inicio</span></a>
                <a href="#" class="nav-item" data-view="favorites" tabindex="0"><i class="fas fa-heart"></i> <span>Favoritos</span></a>
                <a href="peliculas.html" class="nav-item" tabindex="0"><i class="fas fa-film"></i> <span>Películas</span></a>
                <a href="series.html" class="nav-item" tabindex="0"><i class="fas fa-tv"></i> <span>Series</span></a>
            </nav>
            <div class="main-content-wrapper">
                <main class="main-content">
                    <div class="categories-section"></div>
                    <div class="channel-header">
                        <h2 class="section-title">TODOS</h2>
                    </div>
                    <div id="loading-spinner" class="spinner-container">
                        <div class="spinner"></div>
                    </div>
                    <ul class="channel-list"></ul>
                </main>
            </div>
        </div>

    </div>
    <nav class="bottom-nav">
        <a href="index.html" class="nav-item active" data-view="all"><i class="fas fa-home"></i> <span>Inicio</span></a>
        <a href="#" class="nav-item" data-view="favorites"><i class="fas fa-heart"></i> <span>Favoritos</span></a>
        <a href="peliculas.html" class="nav-item"><i class="fas fa-film"></i> <span>Películas</span></a>
        <a href="series.html" class="nav-item"><i class="fas fa-tv"></i> <span>Series</span></a>
    </nav>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, doc, setDoc, deleteDoc, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        const firebaseConfig = { apiKey: "AIzaSyCLGiT_UeTm578cQeCwLldH50qOjounCOs", authDomain: "miappdetv-db.firebaseapp.com", projectId: "miappdetv-db", storageBucket: "miappdetv-db.firebasestorage.app", messagingSenderId: "515640857376", appId: "1:515640857376:web:89e5bb051ee79f030c3d45" };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        let userId;
        window.allChannelsList = [];
        window.favoritesList = [];
        async function loadAllData() {
            try {
                document.getElementById('loading-spinner').style.display = 'flex';
                const [userCredential, channelsSnapshot] = await Promise.all([ signInAnonymously(auth), getDocs(collection(db, "canales")) ]);
                userId = userCredential.user.uid;
                window.allChannelsList = channelsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                window.categorias = [...new Set(window.allChannelsList.map(c => c.categoria))];
                window.renderCategories();
                window.renderChannels(window.allChannelsList, []); 
                setupFavoritesListener();
            } catch (e) { console.error('Error al cargar datos:', e); } 
            finally { document.getElementById('loading-spinner').style.display = 'none'; }
        }
        function setupFavoritesListener() {
            const favoritesRef = collection(db, `users/${userId}/favorites`);
            onSnapshot(favoritesRef, (snapshot) => {
                window.favoritesList = snapshot.docs.map(doc => doc.id);
                const currentView = document.querySelector('.side-nav .active')?.dataset.view || document.querySelector('.bottom-nav .active')?.dataset.view;
                if (currentView === 'favorites') { window.filterAndRenderChannels('FAVORITOS'); } 
                else { const currentCategory = document.querySelector('.category-item.active')?.dataset.category || 'TODOS'; window.filterAndRenderChannels(currentCategory); }
            });
        }
        window.toggleFavorite = async (channel) => {
            const docRef = doc(db, `users/${userId}/favorites`, channel.id);
            const isFavorited = window.favoritesList.includes(channel.id);
            if (isFavorited) { await deleteDoc(docRef); } 
            else { await setDoc(docRef, channel); }
        };
        loadAllData();
    </script>
    
    <script>
        window['__onGCastApiAvailable'] = function(isAvailable) { if (isAvailable) { initializeCastApi(); } };
        function initializeCastApi() {
            cast.framework.CastContext.getInstance().setOptions({
                receiverApplicationId: 'D066AED3',
                autoJoinPolicy: chrome.cast.AutoJoinPolicy.ORIGIN_SCOPED
            });
        }
        function castChannel(channel) {
            const castSession = cast.framework.CastContext.getInstance().getCurrentSession();
            if (!castSession) { alert("Para transmitir, primero haz clic en el ícono de Cast y elige tu dispositivo."); return; }
            const mediaInfo = new chrome.cast.media.MediaInfo(channel.m3u8_url, 'application/vnd.apple.mpegurl');
            mediaInfo.metadata = new chrome.cast.media.GenericMediaMetadata();
            mediaInfo.metadata.title = channel.nombre;
            mediaInfo.metadata.images = [{ 'url': channel.logo_url }];
            const request = new chrome.cast.media.LoadRequest(mediaInfo);
            castSession.loadMedia(request).then( () => { showMessageBox('Transmitiendo ' + channel.nombre + ' en tu TV.'); }, (errorCode) => { alert('Error al transmitir: ' + errorCode); } );
        }

        const videoPlayer = document.getElementById('videoPlayer');
        const videoPlaceholder = document.querySelector('.video-placeholder');
        const videoOverlay = document.querySelector('.video-overlay');
        const channelList = document.querySelector('.channel-list');
        const categoriesDiv = document.querySelector('.categories-section');
        const searchInput = document.getElementById('search-input');
        const searchIcon = document.querySelector('.search-icon');
        const playPauseBtn = document.getElementById('playPauseBtn');
        const muteBtn = document.getElementById('muteBtn');
        const fullscreenBtn = document.getElementById('fullscreenBtn');
        const progressBar = document.getElementById('progressBar');
        const progressBarContainer = document.getElementById('progressBarContainer');
        const videoTime = document.getElementById('videoTime');
        const volumeSlider = document.getElementById('volumeSlider');
        const volumeSliderContainer = document.getElementById('volumeSliderContainer');
        const videoContainer = document.getElementById('video-container');
        let overlayTimeout;

        function showMessageBox(message, duration = 3000) {
            const messageBox = document.getElementById('messageBox');
            messageBox.textContent = message;
            messageBox.style.display = 'block';
            setTimeout(() => { messageBox.style.display = 'none'; }, duration);
        }

        window.filterAndRenderChannels = function(category) {
            let channelsToRender;
            const categoriesSection = document.querySelector('.categories-section');
            const channelHeader = document.querySelector('.channel-header');
            categoriesSection.style.display = 'flex';
            channelHeader.style.display = 'flex';
            if (category === 'FAVORITOS') {
                document.querySelector('.section-title').textContent = 'MIS FAVORITOS';
                categoriesSection.style.display = 'none';
                channelHeader.style.display = 'none';
                channelsToRender = window.allChannelsList.filter(c => window.favoritesList.includes(c.id));
            } else {
                document.querySelector('.section-title').textContent = category.toUpperCase();
                channelsToRender = category === 'TODOS' ? window.allChannelsList : window.allChannelsList.filter(c => c.categoria === category);
            }
            window.renderChannels(channelsToRender, window.favoritesList);
        }
        
        window.renderCategories = function() {
            categoriesDiv.innerHTML = `<div class="category-item active" data-category="TODOS" tabindex="0">TODOS</div>` + 
                                      window.categorias.map(cat => cat ? `<div class="category-item" data-category="${cat}" tabindex="0">${cat}</div>` : '').join('');
            
            categoriesDiv.querySelectorAll('.category-item').forEach(btn => {
                const category = btn.dataset.category;
                const action = () => {
                    categoriesDiv.querySelector('.active').classList.remove('active');
                    btn.classList.add('active');
                    window.filterAndRenderChannels(category);
                };
                btn.addEventListener('click', action);
                btn.addEventListener('keydown', (e) => { if (e.key === 'Enter') action(); });
            });
        }

        window.renderChannels = function(channels, favorites) {
            channelList.innerHTML = '';
            if (channels.length === 0) {
                 channelList.innerHTML = '<li style="text-align:center;padding:20px;">No hay canales en esta categoría.</li>';
                 return;
            }
            channels.forEach(channel => {
                const isFavorited = favorites.includes(channel.id);
                const li = document.createElement('li');
                li.className = 'channel-item';
                li.setAttribute('tabindex', '0'); 
                li.innerHTML = `
                    <div class="channel-logo-container">
                        <img src="${channel.logo_url}" alt="${channel.nombre} Logo" class="channel-logo" loading="lazy" onerror="this.onerror=null;this.src='https://placehold.co/50x50/2c2c44/ecf0f1?text=IMG'"/>
                        <div class="channel-details"><h3>${channel.nombre}</h3><p>${channel.categoria || 'General'}</p></div>
                    </div>
                    <div class="channel-actions">
                        <i class="fas fa-heart ${isFavorited ? 'favorited' : ''}"></i>
                        <i class="fas fa-cast cast-icon"></i>
                    </div>
                `;
                li.querySelector('.channel-logo-container').addEventListener('click', () => playCanal(channel));
                li.addEventListener('keydown', (e) => { if (e.key === 'Enter' || e.keyCode === 13) playCanal(channel); });
                li.querySelector('.cast-icon').addEventListener('click', (e) => { e.stopPropagation(); castChannel(channel); });
                li.querySelector('.fa-heart').addEventListener('click', (e) => { e.stopPropagation(); window.toggleFavorite(channel); });
                channelList.appendChild(li);
            });
        }
        
        function playCanal(channel) {
            videoPlaceholder.style.display = 'none';
            videoPlayer.style.display = 'block';
            videoOverlay.classList.remove('hidden');
            const finalUrl = channel.m3u8_url;
            if (videoPlayer.hls) videoPlayer.hls.destroy();
            document.getElementById('epgCurrentProgram').textContent = channel.nombre;
            if (Hls.isSupported()) {
                const hls = new Hls();
                hls.loadSource(finalUrl);
                hls.attachMedia(videoPlayer);
                videoPlayer.hls = hls;
            } else if (videoPlayer.canPlayType('application/vnd.apple.mpegurl')) {
                videoPlayer.src = finalUrl;
            }
            videoPlayer.play();
        }

        function handleNavClick(view) {
            document.querySelectorAll('.side-nav .nav-item').forEach(i => i.classList.remove('active'));
            document.querySelectorAll('.bottom-nav .nav-item').forEach(i => i.classList.remove('active'));
            document.querySelectorAll(`[data-view=${view}]`).forEach(el => el.classList.add('active'));
            if (view === 'favorites') { window.filterAndRenderChannels('FAVORITOS'); } 
            else if (view === 'all') {
                const categoriesSection = document.querySelector('.categories-section');
                categoriesSection.querySelector('.active')?.classList.remove('active');
                categoriesSection.querySelector('[data-category="TODOS"]').classList.add('active');
                window.filterAndRenderChannels('TODOS');
            }
        }
        
        document.querySelectorAll('.nav-item').forEach(item => {
            item.addEventListener('click', (e) => {
                const view = item.dataset.view;
                if (!view) return;
                e.preventDefault();
                handleNavClick(view);
            });
        });

        searchIcon.addEventListener('click', () => {
            searchInput.classList.toggle('active');
            if (searchInput.classList.contains('active')) searchInput.focus();
        });

        playPauseBtn.addEventListener('click', () => { if (videoPlayer.paused) videoPlayer.play(); else videoPlayer.pause(); });
        muteBtn.addEventListener('click', () => { videoPlayer.muted = !videoPlayer.muted; });
        videoPlayer.addEventListener('volumechange', () => {
            volumeSlider.style.width = (videoPlayer.volume * 100) + '%';
            muteBtn.className = (videoPlayer.muted || videoPlayer.volume === 0) ? 'fas fa-volume-mute' : 'fas fa-volume-up';
        });
        volumeSliderContainer.addEventListener('click', (e) => {
            const rect = volumeSliderContainer.getBoundingClientRect();
            videoPlayer.volume = (e.clientX - rect.left) / rect.width;
        });
        videoPlayer.addEventListener('timeupdate', () => {
            if (isFinite(videoPlayer.duration)) {
                progressBar.style.width = `${(videoPlayer.currentTime / videoPlayer.duration) * 100}%`;
                const formatTime = t => `${String(Math.floor(t/60)).padStart(2,'0')}:${String(Math.floor(t%60)).padStart(2,'0')}`;
                videoTime.textContent = `${formatTime(videoPlayer.currentTime)} / ${formatTime(videoPlayer.duration)}`;
            } else {
                progressBar.style.width = '100%';
                videoTime.textContent = 'En vivo';
            }
        });
        progressBarContainer.addEventListener('click', (e) => {
            if (isFinite(videoPlayer.duration)) {
                const rect = progressBarContainer.getBoundingClientRect();
                videoPlayer.currentTime = ((e.clientX - rect.left) / rect.width) * videoPlayer.duration;
            }
        });
        function hideOverlay() {
            clearTimeout(overlayTimeout);
            overlayTimeout = setTimeout(() => { videoOverlay.classList.remove('visible'); }, 3000);
        }
        videoContainer.addEventListener('click', (e) => {
            if (e.target.closest('.video-custom-controls')) return;
            videoOverlay.classList.toggle('visible');
            if (videoOverlay.classList.contains('visible')) hideOverlay();
            else clearTimeout(overlayTimeout);
        });
        fullscreenBtn.addEventListener('click', () => {
            if (!document.fullscreenElement) videoContainer.requestFullscreen();
            else document.exitFullscreen();
        });
        document.addEventListener('fullscreenchange', () => {
            fullscreenBtn.className = document.fullscreenElement ? 'fas fa-compress' : 'fas fa-expand';
        });
        videoPlayer.addEventListener('play', () => { playPauseBtn.className = 'fas fa-pause'; });
        videoPlayer.addEventListener('pause', () => { playPauseBtn.className = 'fas fa-play'; });
    </script>
</body>
</html>
