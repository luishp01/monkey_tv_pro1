<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Series - MonkeyTV PRO</title>
    <style>
        body { font-family: sans-serif; background-color: #1a1a2e; color: #ecf0f1; padding: 20px; }
        .container { max-width: 900px; margin: auto; }
        h1, h2, h3 { color: #e74c3c; text-align: center; }
        .admin-section { background-color: #2c2c44; padding: 20px; border-radius: 10px; margin-bottom: 20px; }
        input, button, select, textarea {
            width: 100%; padding: 10px; margin-bottom: 10px; border-radius: 5px; border: 1px solid #555;
            background-color: #1a1a2e; color: #ecf0f1; box-sizing: border-box;
        }
        button { background-color: #3498db; cursor: pointer; border: none; font-weight: bold; }
        button:hover { opacity: 0.8; }
        button:disabled { background-color: #555; cursor: not-allowed; }
        .search-container { display: flex; gap: 10px; }
        #search-results { list-style: none; padding: 0; max-height: 250px; overflow-y: auto; }
        .result-item { display: flex; align-items: center; gap: 10px; padding: 8px; cursor: pointer; border-radius: 5px; }
        .result-item:hover { background-color: #1a1a2e; }
        .result-item img { width: 40px; border-radius: 3px; }

        #series-details-form, #episodes-container { display: none; }
        #episodes-list { list-style: none; padding: 0; }
        .episode-item { display: grid; grid-template-columns: 50px 1fr 2fr; align-items: center; gap: 10px; background-color: #1a1a2e; padding: 10px; border-radius: 5px; margin-bottom: 8px; }
        .episode-item span { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        .existing-series-item { display: flex; justify-content: space-between; align-items: center; background-color: #1a1a2e; padding: 10px; border-radius: 5px; margin-bottom: 8px; }
        .existing-series-item span { flex-grow: 1; padding-right: 15px; }
        .existing-series-item .actions button { width: auto; padding: 5px 10px; font-size: 0.8em; }
        .delete-btn { background-color: #e74c3c; }

        #login-form { background-color: #2c2c44; padding: 30px; border-radius: 10px; max-width: 400px; margin: 50px auto; text-align: center; }
        #login-form h2 { margin-bottom: 20px; }
        #login-form input { width: 90%; padding: 10px; margin-bottom: 15px; border-radius: 5px; border: 1px solid #555; background-color: #1a1a2e; color: #ecf0f1; }
        #login-form button { width: 90%; padding: 12px; background-color: #e74c3c; color: white; border: none; border-radius: 5px; cursor: pointer; }
        #admin-main-container { display: none; } /* Ocultamos todo el contenido del admin */
    </style>
</head>
<body>
    <div class="container">

        <div id="login-form">
            <h2>Admin Series - Iniciar Sesión</h2>
            <input type="email" id="login-email" placeholder="Correo Electrónico" required>
            <input type="password" id="login-password" placeholder="Contraseña" required>
            <button id="login-button">Entrar</button>
        </div>

        <div id="admin-main-container">
            <h1>Administración de Series</h1>

            <div class="admin-section">
                <h2>Paso 1: Buscar Nueva Serie en TMDb</h2>
                <div class="search-container">
                    <input type="text" id="series-search-input" placeholder="Buscar por nombre de serie...">
                    <button id="search-series-btn">Buscar</button>
                </div>
                <ul id="search-results"></ul>
            </div>

            <div class="admin-section" id="series-details-form">
                <h2>Paso 2: Revisar Detalles y Seleccionar Temporada</h2>
                <input type="hidden" id="series-id">
                <label>Título:</label> <input type="text" id="series-title">
                <label>Sinopsis:</label> <textarea id="series-overview" rows="4"></textarea>
                <label>URL Póster:</label> <input type="text" id="series-poster">
                <label>URL Fondo:</label> <input type="text" id="series-backdrop">
                <hr style="border-color: #555; margin: 20px 0;">
                <label>Seleccionar Temporada:</label> <select id="season-selector"></select>
            </div>

            <div class="admin-section" id="episodes-container">
                <h2>Paso 3: Añadir/Editar URLs de Video a los Episodios</h2>
                <ul id="episodes-list"></ul>
                <button id="save-series-btn" style="background-color: #2ecc71;">Guardar Cambios en Firebase</button>
            </div>
            
            <div class="admin-section">
                <h2>Series Existentes en Firebase</h2>
                <input type="text" id="existing-series-search" placeholder="Buscar en tus series guardadas...">
                <div id="existing-series-list"></div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, collection, getDocs, writeBatch, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCLGiT_UeTm578cQeCwLldH50qOjounCOs",
            authDomain: "miappdetv-db.firebaseapp.com",
            projectId: "miappdetv-db",
            storageBucket: "miappdetv-db.firebasestorage.app",
            messagingSenderId: "515640857376",
            appId: "1:515640857376:web:89e5bb051ee79f030c3d45"
        };
        
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        
        const TMDB_API_KEY = "6b08760aef7b20713371d73d461c9c57";
        const TMDB_API_URL = "https://api.themoviedb.org/3";

        const loginForm = document.getElementById('login-form');
        const adminContainer = document.getElementById('admin-main-container');
        const loginButton = document.getElementById('login-button');

        const searchInput = document.getElementById('series-search-input');
        const searchBtn = document.getElementById('search-series-btn');
        const searchResults = document.getElementById('search-results');
        const seriesDetailsForm = document.getElementById('series-details-form');
        const episodesContainer = document.getElementById('episodes-container');
        const seasonSelector = document.getElementById('season-selector');
        const episodesList = document.getElementById('episodes-list');
        const saveBtn = document.getElementById('save-series-btn');
        const existingSeriesSearch = document.getElementById('existing-series-search');
        const existingSeriesList = document.getElementById('existing-series-list');

        let currentSeriesData = {};
        let allExistingSeries = [];

        // --- LÓGICA DE INICIO DE SESIÓN ---
        loginButton.addEventListener('click', async () => {
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            try {
                await signInWithEmailAndPassword(auth, email, password);
                loginForm.style.display = 'none';
                adminContainer.style.display = 'block';
                loadExistingSeries();
            } catch (error) {
                console.error("Error de inicio de sesión:", error);
                alert("Error de inicio de sesión. Verifica tus credenciales.");
            }
        });

        async function searchSeries() { /* ... sin cambios ... */ }
        async function selectSeriesFromTMDb(seriesId) { /* ... sin cambios ... */ }
        function fillSeriesForm(seriesData) { /* ... sin cambios ... */ }
        async function loadSeasonFromTMDb(seriesId, seasonNumber, existingEpisodes = []) { /* ... sin cambios ... */ }
        
        async function saveSeriesToFirebase() {
            const seriesId = document.getElementById('series-id').value;
            if (!seriesId) { alert("No hay una serie seleccionada."); return; }
            saveBtn.disabled = true;
            saveBtn.textContent = "Guardando...";
            try {
                const batch = writeBatch(db);
                const seriesDocRef = doc(db, "series", seriesId);
                batch.set(seriesDocRef, {
                    id: seriesId,
                    titulo: document.getElementById('series-title').value,
                    sinopsis: document.getElementById('series-overview').value,
                    poster_url: document.getElementById('series-poster').value,
                    backdrop_url: document.getElementById('series-backdrop').value
                });
                const seasonNumber = seasonSelector.value;
                const seasonDocRef = doc(collection(seriesDocRef, "temporadas"), `temporada_${seasonNumber}`);
                const seasonData = currentSeriesData.seasons.find(s => s.season_number == seasonNumber);
                batch.set(seasonDocRef, {
                    nombre: seasonData.name,
                    numero: parseInt(seasonData.season_number),
                    poster_url: `https://image.tmdb.org/t/p/w500${seasonData.poster_path}`
                });

                // Aquí no podemos obtener los datos de la API, ya que solo guardamos las URLs
                // Nos basamos en los inputs que se están mostrando en la pantalla
                const episodeItems = episodesList.querySelectorAll('.episode-item');
                for (const item of episodeItems) {
                    const epNumber = item.dataset.episodeNumber;
                    const videoUrl = item.querySelector('input').value.trim();
                    const episodeDocRef = doc(collection(seasonDocRef, "episodios"), `episodio_${epNumber}`);
                    
                    // Necesitamos obtener los datos del episodio que no están en el DOM
                    const epTitle = item.querySelector('span:nth-child(2)').textContent;
                    
                    // Lo ideal es tener todos los datos a mano antes de guardar.
                    // Para simplificar, solo guardamos la URL. 
                    // Si quisiéramos guardar más datos, habría que almacenarlos en `currentSeriesData`
                    batch.set(episodeDocRef, { 
                        numero: parseInt(epNumber),
                        titulo: epTitle,
                        video_url: videoUrl
                    }, { merge: true });
                };
                
                await batch.commit();
                alert(`¡Datos de la serie guardados con éxito!`);
                await loadExistingSeries();
            } catch (e) {
                console.error("Error al guardar la serie:", e);
                alert("Ocurrió un error al guardar. Revisa la consola (F12).");
            } finally {
                saveBtn.disabled = false;
                saveBtn.textContent = "Guardar Cambios en Firebase";
            }
        }
        
        async function loadExistingSeries() {
            const snapshot = await getDocs(collection(db, "series"));
            allExistingSeries = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            renderExistingSeries(allExistingSeries);
        }

        function renderExistingSeries(seriesArray) { /* ... sin cambios ... */ }
        async function editSeries(seriesId) { /* ... sin cambios ... */ }

        async function deleteSeries(seriesId, seriesTitle) {
            if (confirm(`¿SEGURO de que quieres eliminar TODA la serie "${seriesTitle}"? Esto no se puede deshacer.`)) {
                // Para borrar subcolecciones, la forma más fácil es hacerlo desde el cliente, aunque es lento.
                // Primero borramos todos los episodios de todas las temporadas.
                try {
                    const temporadasSnapshot = await getDocs(collection(db, `series/${seriesId}/temporadas`));
                    for (const temporadaDoc of temporadasSnapshot.docs) {
                        const episodiosSnapshot = await getDocs(collection(temporadaDoc.ref, "episodios"));
                        for (const episodioDoc of episodiosSnapshot.docs) {
                            await deleteDoc(episodioDoc.ref);
                        }
                        await deleteDoc(temporadaDoc.ref);
                    }
                    // Finalmente, borramos el documento principal de la serie.
                    await deleteDoc(doc(db, "series", seriesId));
                    alert("Serie eliminada por completo.");
                    loadExistingSeries();
                } catch (e) {
                    console.error("Error al eliminar:", e);
                    alert("Error al eliminar la serie. Revisa la consola.");
                }
            }
        }

        // El resto de tus funciones y listeners (sin cambios)
        existingSeriesSearch.addEventListener('input', () => { /*...*/ });
        searchBtn.addEventListener('click', searchSeries);
        searchInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') searchSeries(); });
        seasonSelector.addEventListener('change', () => {
            editSeries(document.getElementById('series-id').value);
        });
        saveBtn.addEventListener('click', saveSeriesToFirebase);
    </script>
</body>
</html>
