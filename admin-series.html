<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Series - MonkeyTV PRO</title>
    <style>
        body { font-family: sans-serif; background-color: #1a1a2e; color: #ecf0f1; padding: 20px; }
        .container { max-width: 900px; margin: auto; }
        h1, h2, h3 { color: #e74c3c; text-align: center; }
        .admin-section { background-color: #2c2c44; padding: 20px; border-radius: 10px; margin-bottom: 20px; }
        input, button, select, textarea {
            width: 100%; padding: 10px; margin-bottom: 10px; border-radius: 5px; border: 1px solid #555;
            background-color: #1a1a2e; color: #ecf0f1; box-sizing: border-box; font-size: 1em;
        }
        button { background-color: #3498db; cursor: pointer; border: none; font-weight: bold; }
        button:hover { opacity: 0.8; }
        button:disabled { background-color: #555; cursor: not-allowed; }
        .search-container { display: flex; gap: 10px; }
        #search-results { list-style: none; padding: 0; max-height: 250px; overflow-y: auto; }
        .result-item { display: flex; align-items: center; gap: 10px; padding: 8px; cursor: pointer; border-radius: 5px; }
        .result-item:hover { background-color: #1a1a2e; }
        .result-item img { width: 40px; border-radius: 3px; }
        #series-details-form, #episodes-container { display: none; }
        #episodes-list { list-style: none; padding: 0; }
        .episode-item { display: grid; grid-template-columns: 50px 1fr 2fr; align-items: center; gap: 10px; background-color: #1a1a2e; padding: 10px; border-radius: 5px; margin-bottom: 8px; }
        .episode-item input { width: 100%; }
        .episode-item span { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        #login-form { background-color: #2c2c44; padding: 30px; border-radius: 10px; max-width: 400px; margin: 50px auto; text-align: center; }
        #login-form input { width: 90%; }
        #login-form button { width: 90%; background-color: #e74c3c; }
        #admin-main-container { display: none; }
        .existing-series-item { display: flex; justify-content: space-between; align-items: center; background-color: #1a1a2e; padding: 10px; border-radius: 5px; margin-bottom: 8px; }
        .existing-series-item span { flex-grow: 1; padding-right: 15px; }
        .existing-series-item .actions button { width: auto; padding: 5px 10px; font-size: 0.8em; margin-left: 5px; }
        .delete-btn { background-color: #e74c3c; }
    </style>
</head>
<body>
    <div class="container">
        <div id="login-form">
            <h2>Admin Series - Iniciar Sesión</h2>
            <input type="email" id="login-email" placeholder="Correo Electrónico" required>
            <input type="password" id="login-password" placeholder="Contraseña" required>
            <button id="login-button">Entrar</button>
        </div>
        <div id="admin-main-container">
            <h1>Administración de Series</h1>
            <div class="admin-section">
                <h2>Buscar/Editar Serie</h2>
                <div class="search-container">
                    <input type="text" id="series-search-input" placeholder="Buscar nueva serie en TMDb...">
                    <button id="search-series-btn">Buscar</button>
                </div>
                <ul id="search-results"></ul>
            </div>
            <div class="admin-section" id="series-details-form">
                <h2>Detalles y Temporadas</h2>
                <input type="hidden" id="series-id">
                <label>Título:</label> <input type="text" id="series-title">
                <label>URL Póster:</label> <input type="text" id="series-poster">
                <label>URL Fondo (Backdrop):</label> <input type="text" id="series-backdrop">
                <label>Sinopsis:</label> <textarea id="series-overview" rows="4"></textarea>
                <button id="save-series-details-btn">1. Guardar/Actualizar Detalles de la Serie</button>
                <hr style="border-color: #555; margin: 20px 0;">
                <label>Seleccionar Temporada:</label> <select id="season-selector"></select>
                <button id="save-episodes-btn" style="background-color: #2ecc71;">2. Guardar URLs de esta Temporada</button>
            </div>
            <div class="admin-section" id="episodes-container">
                <h3 id="episodes-header">Episodios</h3>
                <ul id="episodes-list"></ul>
            </div>
            <div class="admin-section">
                <h2>Series Existentes en Firebase</h2>
                <input type="text" id="existing-series-search" placeholder="Buscar en tus series guardadas...">
                <div id="existing-series-list"></div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, collection, getDocs, writeBatch, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = { apiKey: "AIzaSyCLGiT_UeTm578cQeCwLldH50qOjounCOs", authDomain: "miappdetv-db.firebaseapp.com", projectId: "miappdetv-db", storageBucket: "miappdetv-db.firebasestorage.app", messagingSenderId: "515640857376", appId: "1:515640857376:web:89e5bb051ee79f030c3d45" };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        
        const TMDB_API_KEY = "6b08760aef7b20713371d73d461c9c57";
        const TMDB_API_URL = "https://api.themoviedb.org/3";

        const loginForm = document.getElementById('login-form');
        const adminContainer = document.getElementById('admin-main-container');
        const loginButton = document.getElementById('login-button');
        let currentSeriesData = {};
        let allExistingSeries = [];

        loginButton.addEventListener('click', async () => {
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            try {
                await signInWithEmailAndPassword(auth, email, password);
                loginForm.style.display = 'none';
                adminContainer.style.display = 'block';
                initializeAppLogic();
            } catch (error) {
                alert("Error de inicio de sesión.");
            }
        });

        function initializeAppLogic() {
            const searchInput = document.getElementById('series-search-input');
            const searchBtn = document.getElementById('search-series-btn');
            const searchResults = document.getElementById('search-results');
            const seriesDetailsForm = document.getElementById('series-details-form');
            const episodesContainer = document.getElementById('episodes-container');
            const seasonSelector = document.getElementById('season-selector');
            const episodesList = document.getElementById('episodes-list');
            const saveDetailsBtn = document.getElementById('save-series-details-btn');
            const saveEpisodesBtn = document.getElementById('save-episodes-btn');
            const existingSeriesSearch = document.getElementById('existing-series-search');
            const existingSeriesList = document.getElementById('existing-series-list');

            async function searchSeries() {
                const query = searchInput.value; if (!query) return;
                const url = `${TMDB_API_URL}/search/tv?api_key=${TMDB_API_KEY}&query=${encodeURIComponent(query)}&language=es-MX`;
                const response = await fetch(url); const data = await response.json();
                searchResults.innerHTML = '';
                data.results.slice(0, 5).forEach(series => {
                    const li = document.createElement('li');
                    li.className = 'result-item';
                    li.innerHTML = `<img src="${series.poster_path ? 'https://image.tmdb.org/t/p/w92' + series.poster_path : ''}" /> <span>${series.name}</span>`;
                    li.onclick = () => selectSeries(series.id);
                    searchResults.appendChild(li);
                });
            }
            
            async function selectSeries(seriesId) {
                searchResults.innerHTML = '';
                const url = `${TMDB_API_URL}/tv/${seriesId}?api_key=${TMDB_API_KEY}&language=es-MX`;
                const data = await (await fetch(url)).json();
                
                currentSeriesData = {
                    id: data.id.toString(), titulo: data.name,
                    poster_url: data.poster_path ? `https://image.tmdb.org/t/p/w500${data.poster_path}` : '',
                    backdrop_url: data.backdrop_path ? `https://image.tmdb.org/t/p/w1280${data.backdrop_path}` : '',
                    sinopsis: data.overview,
                    seasons: data.seasons.filter(s => s.season_number > 0 && s.episode_count > 0)
                };
                
                document.getElementById('series-id').value = currentSeriesData.id;
                document.getElementById('series-title').value = currentSeriesData.titulo;
                document.getElementById('series-poster').value = currentSeriesData.poster_url;
                document.getElementById('series-backdrop').value = currentSeriesData.backdrop_url;
                document.getElementById('series-overview').value = currentSeriesData.sinopsis;
                
                seasonSelector.innerHTML = '';
                currentSeriesData.seasons.forEach(season => {
                    const option = document.createElement('option');
                    option.value = season.season_number; option.textContent = season.name;
                    seasonSelector.appendChild(option);
                });
                
                seriesDetailsForm.style.display = 'block';
                episodesContainer.style.display = 'block';
                if (seasonSelector.options.length > 0) { await loadSeason(currentSeriesData.id, seasonSelector.value); }
                else { episodesList.innerHTML = '<li>Esta serie no tiene temporadas disponibles.</li>'; }
            }

            async function loadSeason(seriesId, seasonNumber) {
                document.getElementById('episodes-header').textContent = `Episodios - Temporada ${seasonNumber}`;
                const tmdbUrl = `${TMDB_API_URL}/tv/${seriesId}/season/${seasonNumber}?api_key=${TMDB_API_KEY}&language=es-MX`;
                const response = await fetch(tmdbUrl); const tmdbData = await response.json();

                const seriesDocRef = doc(db, "series", seriesId);
                const temporadaDocRef = doc(collection(seriesDocRef, "temporadas"), `temporada_${seasonNumber}`);
                const episodiosRef = collection(temporadaDocRef, "episodios");

                const firebaseSnapshot = await getDocs(episodiosRef);
                const existingEpisodes = {};
                firebaseSnapshot.forEach(doc => { existingEpisodes[doc.id] = doc.data(); });
                
                episodesList.innerHTML = '';
                tmdbData.episodes.forEach(ep => {
                    const firebaseEp = existingEpisodes[`episodio_${ep.episode_number}`];
                    const li = document.createElement('li');
                    li.className = 'episode-item';
                    li.dataset.episodeNumber = ep.episode_number; li.dataset.episodeName = ep.name;
                    li.innerHTML = `<span><b>E${ep.episode_number}</b></span><span>${ep.name}</span><input type="text" placeholder="URL del video..." value="${firebaseEp && firebaseEp.video_url ? firebaseEp.video_url : ''}">`;
                    episodesList.appendChild(li);
                });
            }
            
            async function saveSeriesDetails() {
                const seriesId = document.getElementById('series-id').value; if (!seriesId) return;
                saveDetailsBtn.disabled = true;
                const seriesDocRef = doc(db, "series", seriesId);
                try {
                    await setDoc(seriesDocRef, {
                        id: seriesId, titulo: document.getElementById('series-title').value,
                        poster_url: document.getElementById('series-poster').value,
                        backdrop_url: document.getElementById('series-backdrop').value,
                        sinopsis: document.getElementById('series-overview').value
                    }, { merge: true });
                    alert('Detalles de la serie guardados.');
                    await loadExistingSeries();
                } catch(e) { console.error(e); } finally { saveDetailsBtn.disabled = false; }
            }

            async function saveSeasonEpisodes() {
                const seriesId = document.getElementById('series-id').value;
                const seasonNumber = seasonSelector.value;
                if (!seriesId || !seasonNumber) return;

                saveEpisodesBtn.disabled = true;
                try {
                    const batch = writeBatch(db);
                    const seriesDocRef = doc(db, "series", seriesId);
                    const temporadaDocRef = doc(collection(seriesDocRef, "temporadas"), `temporada_${seasonNumber}`);
                    
                    // --------- LA SOLUCIÓN MÁGICA ESTÁ AQUÍ ---------
                    // Le añadimos datos al documento de la temporada para que "exista" de verdad.
                    const seasonName = seasonSelector.options[seasonSelector.selectedIndex].text;
                    batch.set(temporadaDocRef, {
                        numero: parseInt(seasonNumber),
                        nombre: seasonName
                    }, { merge: true });
                    // ------------------------------------------------

                    document.querySelectorAll('.episode-item').forEach(item => {
                        const epNumber = item.dataset.episodeNumber;
                        const epName = item.dataset.episodeName;
                        const videoUrl = item.querySelector('input').value.trim();
                        const episodioRef = doc(collection(temporadaDocRef, "episodios"), `episodio_${epNumber}`);
                        batch.set(episodioRef, { numero: parseInt(epNumber), titulo: epName, video_url: videoUrl });
                    });

                    await batch.commit();
                    alert(`Episodios de la Temporada ${seasonNumber} guardados.`);
                } catch (e) { console.error("Error guardando episodios:", e); } 
                finally { saveEpisodesBtn.disabled = false; }
            }
            
            async function loadExistingSeries() {
                const snapshot = await getDocs(collection(db, "series"));
                allExistingSeries = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderExistingSeries(allExistingSeries);
            }

            function renderExistingSeries(seriesArray) {
                existingSeriesList.innerHTML = '';
                seriesArray.forEach(series => {
                    const div = document.createElement('div');
                    div.className = 'existing-series-item';
                    div.innerHTML = `<span>${series.titulo}</span><div class="actions"><button class="edit-btn">Editar</button><button class="delete-btn">Borrar</button></div>`;
                    div.querySelector('.edit-btn').onclick = () => editSeries(series.id);
                    div.querySelector('.delete-btn').onclick = () => deleteSeries(series.id, series.titulo);
                    existingSeriesList.appendChild(div);
                });
            }
            
            async function editSeries(seriesId) { window.scrollTo(0, 0); await selectSeries(seriesId); }

            async function deleteSeries(seriesId, seriesTitle) {
                if (confirm(`¿SEGURO de que quieres eliminar TODA la serie "${seriesTitle}"? Esto borrará sus temporadas y episodios.`)) {
                    try {
                        const seriesDocRef = doc(db, "series", seriesId);
                        const temporadasSnapshot = await getDocs(collection(seriesDocRef, "temporadas"));
                        
                        for (const temporadaDoc of temporadasSnapshot.docs) {
                            const episodiosSnapshot = await getDocs(collection(temporadaDoc.ref, "episodios"));
                            for (const episodioDoc of episodiosSnapshot.docs) { await deleteDoc(episodioDoc.ref); }
                            await deleteDoc(temporadaDoc.ref);
                        }
                        
                        await deleteDoc(seriesDocRef);
                        alert("Serie eliminada por completo.");
                        await loadExistingSeries();
                    } catch (e) { alert("Error al eliminar. Revisa la consola."); console.error("Error al eliminar:", e); }
                }
            }

            existingSeriesSearch.addEventListener('input', () => {
                const query = existingSeriesSearch.value.toLowerCase();
                const filtered = allExistingSeries.filter(s => s.titulo.toLowerCase().includes(query));
                renderExistingSeries(filtered);
            });

            searchBtn.addEventListener('click', searchSeries);
            seasonSelector.addEventListener('change', () => loadSeason(currentSeriesData.id, seasonSelector.value));
            saveDetailsBtn.addEventListener('click', saveSeriesDetails);
            saveEpisodesBtn.addEventListener('click', saveSeasonEpisodes);
            
            loadExistingSeries();
        }
    </script>
</body>
</html>
